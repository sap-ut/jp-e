<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>SP-7 ¬∑ Glass Line ERP (Tally Style)</title>
    <!-- Bootstrap 5 + Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Google Font (Tally like) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: #e6e9ef; overflow-x: hidden; }
        .sp-wrapper { display: flex; flex-direction: row; min-height: 100vh; }
        /* sidebar ‚Äì tally inspired */
        .sp-sidebar { width: 260px; background: #1e2b3c; color: #d4dce6; transition: 0.2s; }
        .sp-sidebar .brand { background: #0f1a26; padding: 20px 16px; font-size: 1.7rem; font-weight: 700; letter-spacing: 2px; border-bottom: 1px solid #2a3a4e; color: #fff; }
        .sp-sidebar .brand small { display: block; font-size: 0.7rem; color: #b0c7db; font-weight: 400; }
        .sp-nav { list-style: none; padding: 16px 0; }
        .sp-nav li { padding: 12px 24px; display: flex; align-items: center; gap: 14px; cursor: pointer; transition: 0.1s; border-left: 5px solid transparent; }
        .sp-nav li i { width: 24px; text-align: center; font-size: 1.3rem; }
        .sp-nav li:hover { background: #263b50; border-left: 5px solid #ffb347; color: white; }
        .sp-nav .active { background: #2a4055; border-left: 5px solid #ffaa33; color: white; font-weight: 500; }
        /* main content */
        .sp-main { flex: 1; background: #f2f5f9; padding: 24px; overflow-y: auto; }
        .top-bar { background: white; padding: 16px 28px; border-radius: 18px; box-shadow: 0 6px 12px rgba(0,0,0,0.02); margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        .page-title { font-weight: 600; color: #1e2b3c; font-size: 1.7rem; margin-bottom: 8px; border-left: 7px solid #ffaa33; padding-left: 18px; }
        .card-dash { background: white; border-radius: 24px; padding: 28px; box-shadow: 0 12px 28px rgba(0,0,0,0.02); border: none; margin-bottom: 30px; }
        .tally-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 22px; }
        .stat-card { background: white; border-radius: 20px; padding: 22px; border: 1px solid #eef2f6; box-shadow: 0 4px 10px rgba(0,0,0,0.02); }
        .table th { background: #f0f4fa; color: #1e2b3c; font-weight: 600; }
        .btn-sp { background: #ffaa33; border: none; color: #0b1a26; font-weight: 600; padding: 10px 24px; border-radius: 40px; }
        .btn-sp:hover { background: #f5a22a; color: black; }
        .footer-bar { margin-top: 50px; text-align: center; color: #6c7a8a; font-size: 0.9rem; }
        @media (max-width: 768px) { .sp-sidebar { position: fixed; left: -260px; z-index: 1050; height: 100%; transition: 0.2s; } .sp-sidebar.show { left: 0; } .sp-main { width: 100%; } .mobile-menu-btn { display: block; } }
        .mobile-menu-btn { display: none; font-size: 1.8rem; margin-right: 12px; }
        .department-badge { background: #edf2f9; padding: 6px 16px; border-radius: 50px; font-size: 0.9rem; }
    </style>
</head>
<body>
<div class="sp-wrapper">
    <!-- SIDEBAR : SP-7 TALLY STYLE NAVIGATION -->
    <div class="sp-sidebar" id="sidebar">
        <div class="brand">
            SP-7 <span style="font-size: 0.9rem; color: #b0c7db;">‚ö° Glass</span>
            <small>GST ‚Ä¢ INVENTORY ‚Ä¢ PROFORMA</small>
        </div>
        <ul class="sp-nav">
            <li onclick="showPage('dashboard')" id="nav-dashboard" class="active"><i class="bi bi-speedometer2"></i> Dashboard</li>
            <li onclick="showPage('masters')" id="nav-masters"><i class="bi bi-database"></i> Masters</li>
            <li onclick="showPage('proforma')" id="nav-proforma"><i class="bi bi-file-text"></i> Proforma / PI</li>
            <li onclick="showPage('orderFloor')" id="nav-orderFloor"><i class="bi bi-cone-striped"></i> Work Order</li>
            <li onclick="showPage('despatch')" id="nav-despatch"><i class="bi bi-truck"></i> Despatch Tracker</li>
            <li onclick="showPage('billing')" id="nav-billing"><i class="bi bi-receipt"></i> Billing & GST</li>
            <li onclick="showPage('reports')" id="nav-reports"><i class="bi bi-bar-chart"></i> Reports</li>
            <li onclick="showPage('ledger')" id="nav-ledger"><i class="bi bi-wallet2"></i> Ledger / Hisab</li>
            <li onclick="showPage('backup')" id="nav-backup"><i class="bi bi-cloud-arrow-up"></i> Auto Backup</li>
        </ul>
    </div>

    <!-- MAIN PANEL -->
    <div class="sp-main">
        <div class="top-bar d-flex align-items-center">
            <i class="bi bi-list mobile-menu-btn" onclick="toggleSidebar()"></i>
            <h4 id="topBarTitle" style="margin:0; font-weight: 600;">üìã Dashboard</h4>
            <div><span class="badge bg-dark px-4 py-2">GST READY  |  LIVE DESPATCH</span></div>
        </div>

        <!-- ========== DYNAMIC PAGES LOAD HERE ========== -->
        <div id="pageContent"></div>

        <div class="footer-bar">
            ‚ö° SP-7 ¬∑ Glass Line ERP ¬∑ Tally style ¬∑ Fully working ¬∑ Auto backup
        </div>
    </div>
</div>

<script>
    // -------------------------------------------------------------
    //  GLOBAL DATA ‚Äì stored in localStorage (real persistence)
    // -------------------------------------------------------------
    let appData = {
        customers: [],
        glassTypes: [],
        priceList: [],      // customerId, glassTypeId, rate/sqft
        proformas: [],
        workOrders: [],
        despatches: [],
        invoices: [],
        transactions: []    // ledger entries
    };

    // Load / init localStorage
    function loadData() {
        let stored = localStorage.getItem('sp7_glass_data');
        if (stored) {
            try { appData = JSON.parse(stored); } catch(e){}
        }
        // default masters if empty
        if (appData.glassTypes.length === 0) {
            appData.glassTypes = [
                { id: 1, name: 'Clear Float 4mm', thickness: 4, rate: 45 },
                { id: 2, name: 'Tinted 5mm', thickness: 5, rate: 62 },
                { id: 3, name: 'Toughened 6mm', thickness: 6, rate: 88 },
                { id: 4, name: 'Laminated 8mm', thickness: 8, rate: 140 }
            ];
        }
        if (appData.customers.length === 0) {
            appData.customers = [
                { id: 101, name: 'Shree Glass Works', gst: '27AAECS1234F1Z5', address: 'Surat', phone: '9876543210' },
                { id: 102, name: 'Arora Aluminium', gst: '07ADQPL7896E1Z', address: 'Delhi', phone: '9988776655' }
            ];
        }
        if (appData.priceList.length === 0) {
            appData.priceList = [
                { custId: 101, glassId: 1, customRate: 42 },
                { custId: 101, glassId: 2, customRate: 58 },
                { custId: 102, glassId: 3, customRate: 85 }
            ];
        }
        saveData();
    }
    function saveData() {
        localStorage.setItem('sp7_glass_data', JSON.stringify(appData));
    }
    loadData();

    // Helper: get glass name by id
    function getGlassName(id) {
        let g = appData.glassTypes.find(g=>g.id==id);
        return g? g.name : 'Unknown';
    }
    function getCustomerName(id) {
        let c = appData.customers.find(c=>c.id==id);
        return c? c.name : 'Customer';
    }

    // ---------- UI ROUTING ----------
    function showPage(page) {
        // remove active class
        document.querySelectorAll('.sp-nav li').forEach(el => el.classList.remove('active'));
        document.getElementById(`nav-${page}`).classList.add('active');
        document.getElementById('topBarTitle').innerText = document.getElementById(`nav-${page}`).innerText.replace(' icons?', '').trim();

        const content = document.getElementById('pageContent');
        if (page === 'dashboard') content.innerHTML = renderDashboard();
        else if (page === 'masters') content.innerHTML = renderMasters();
        else if (page === 'proforma') content.innerHTML = renderProforma();
        else if (page === 'orderFloor') content.innerHTML = renderOrderFloor();
        else if (page === 'despatch') content.innerHTML = renderDespatch();
        else if (page === 'billing') content.innerHTML = renderBilling();
        else if (page === 'reports') content.innerHTML = renderReports();
        else if (page === 'ledger') content.innerHTML = renderLedger();
        else if (page === 'backup') content.innerHTML = renderBackup();
    }

    // ------------------------------------------------------------
    //  1. DASHBOARD
    // ------------------------------------------------------------
    function renderDashboard() {
        let totalPI = appData.proformas.length;
        let pendingOrders = appData.workOrders.filter(o => o.status !== 'Completed').length;
        let despatchToday = appData.despatches.filter(d => d.date === new Date().toISOString().slice(0,10)).length;
        return `
            <div class="page-title">üìä Executive Dashboard</div>
            <div class="tally-grid">
                <div class="stat-card"><i class="bi bi-people fs-1" style="color:#ffaa33;"></i><h3 class="mt-2">${appData.customers.length}</h3><span>Customers</span></div>
                <div class="stat-card"><i class="bi bi-file-earmark-text fs-1" style="color:#ffaa33;"></i><h3 class="mt-2">${totalPI}</h3><span>Proforma Invoices</span></div>
                <div class="stat-card"><i class="bi bi-cone fs-1" style="color:#ffaa33;"></i><h3 class="mt-2">${pendingOrders}</h3><span>Pending Orders</span></div>
                <div class="stat-card"><i class="bi bi-truck fs-1" style="color:#ffaa33;"></i><h3 class="mt-2">${despatchToday}</h3><span>Despatched Today</span></div>
            </div>
            <div class="card-dash mt-4">
                <h5>üìå Recent Proformas (Tally style)</h5>
                <table class="table table-borderless">
                    <thead><tr><th>PI No.</th><th>Customer</th><th>Amount</th><th>GST</th><th>Status</th></tr></thead>
                    <tbody>
                        ${appData.proformas.slice(-3).map(p => `<tr><td>PI-${p.id}</td><td>${getCustomerName(p.custId)}</td><td>‚Çπ${p.total}</td><td>‚Çπ${p.gst || 0}</td><td><span class="badge bg-warning">PI Created</span></td></tr>`).join('')}
                        ${appData.proformas.length===0?'<tr><td colspan="5" class="text-muted">No proforma yet. Create from Masters ‚Üí Proforma</td></tr>':''}
                    </tbody>
                </table>
            </div>
        `;
    }

    // ------------------------------------------------------------
    //  2. MASTERS (Customer, Glass, Price List per customer)
    // ------------------------------------------------------------
    function renderMasters() {
        return `
        <div class="page-title">üß∞ Masters (Tally Style)</div>
        <div class="row">
            <div class="col-md-4 mb-4">
                <div class="card-dash">
                    <h5><i class="bi bi-people"></i> Customers</h5>
                    <div id="customerList">
                        ${appData.customers.map(c => `<div class="d-flex justify-content-between border-bottom py-2"><span><strong>${c.name}</strong> <span class="text-muted small">GST: ${c.gst}</span></span> 
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCustomer(${c.id})"><i class="bi bi-trash"></i></button></div>`).join('')}
                    </div>
                    <button class="btn btn-sp mt-3 w-100" onclick="addCustomerPrompt()">+ Add Customer</button>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card-dash">
                    <h5><i class="bi bi-box"></i> Glass Types</h5>
                    ${appData.glassTypes.map(g => `<div class="d-flex justify-content-between"><span>${g.name} (${g.thickness}mm) </span><span>‚Çπ${g.rate}/sqft</span></div>`).join('')}
                    <button class="btn btn-sp mt-3 w-100" onclick="addGlassPrompt()">+ Add Glass</button>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card-dash">
                    <h5><i class="bi bi-tags"></i> Price List (Customer wise)</h5>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${appData.priceList.map(p => {
                            let cust = appData.customers.find(c=>c.id==p.custId);
                            let glass = appData.glassTypes.find(g=>g.id==p.glassId);
                            return `<div class="border-bottom py-1"><small>${cust?.name} ‚Üí ${glass?.name} : <strong>‚Çπ${p.customRate}/sqft</strong></small></div>`;
                        }).join('')}
                    </div>
                    <button class="btn btn-sp mt-3 w-100" onclick="assignPricePrompt()">+ Assign Special Rate</button>
                </div>
            </div>
        </div>
        `;
    }

    // Masters functions (CRUD)
    window.addCustomerPrompt = function() {
        let name = prompt("Customer Name");
        if(!name) return;
        let gst = prompt("GST Number (optional)");
        let newId = Date.now();
        appData.customers.push({ id: newId, name, gst: gst || '', address: '', phone: '' });
        saveData(); showPage('masters');
    }
    window.deleteCustomer = function(id) {
        if(confirm('Delete customer?')) {
            appData.customers = appData.customers.filter(c=>c.id!==id);
            saveData(); showPage('masters');
        }
    }
    window.addGlassPrompt = function() {
        let name = prompt("Glass name e.g. Clear 4mm");
        let thick = prompt("Thickness (mm)");
        let rate = prompt("Base rate per sqft");
        if(name && thick && rate) {
            appData.glassTypes.push({ id: Date.now(), name, thickness: parseFloat(thick), rate: parseFloat(rate) });
            saveData(); showPage('masters');
        }
    }
    window.assignPricePrompt = function() {
        let custId = prompt("Enter Customer ID (from list, e.g. 101)");
        let glassId = prompt("Glass ID (1,2,3,4..)");
        let rate = prompt("Special rate per sqft");
        if(custId && glassId && rate) {
            appData.priceList.push({ custId: parseInt(custId), glassId: parseInt(glassId), customRate: parseFloat(rate) });
            saveData(); showPage('masters');
        }
    }

    // ------------------------------------------------------------
    //  3. PROFORMA INVOICE (Glass items, GST, total) ‚Äì TALLY DETAIL STYLE
    // ------------------------------------------------------------
    function renderProforma() {
        return `
        <div class="page-title">üìÑ Proforma Invoice (PI) Builder</div>
        <div class="card-dash">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label>Select Customer</label>
                    <select id="piCust" class="form-select">
                        ${appData.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label>Party Ref / Date</label>
                    <input type="text" class="form-control" id="piRef" value="PO-${new Date().getTime().toString().slice(-6)}">
                </div>
                <div class="col-md-4 mb-3"><label>GST Treatment</label>
                    <select id="piGstFlag" class="form-select"><option value="18">18% GST</option><option value="12">12% GST</option></select>
                </div>
            </div>
            <hr>
            <h6>‚ûï Add Glass Items (dimensions, type, sqft calc)</h6>
            <div class="row g-2 mb-3">
                <div class="col-3"><input type="number" id="itemWidth" class="form-control" placeholder="Width (ft)"></div>
                <div class="col-3"><input type="number" id="itemHeight" class="form-control" placeholder="Height (ft)"></div>
                <div class="col-3">
                    <select id="itemGlass" class="form-select">
                        ${appData.glassTypes.map(g => `<option value="${g.id}">${g.name} - ‚Çπ${g.rate}/sqft</option>`).join('')}
                    </select>
                </div>
                <div class="col-3"><input type="number" id="itemQty" class="form-control" placeholder="Qty" value="1"></div>
                <div class="col-12 mt-2"><button class="btn btn-sp" onclick="addProformaItem()">‚ûï Add to PI</button></div>
            </div>
            <table class="table table-bordered mt-3" id="piItemsTable">
                <thead><tr><th>Glass</th><th>WxH</th><th>Sqft</th><th>Rate</th><th>Qty</th><th>Amount</th></tr></thead>
                <tbody id="piItemsBody"></tbody>
            </table>
            <div class="row mt-3">
                <div class="col-md-6"><h5>Total (excl tax): ‚Çπ<span id="piSubtotal">0</span></h5></div>
                <div class="col-md-6"><h5>GST (18%): ‚Çπ<span id="piGstAmount">0</span> | Total: ‚Çπ<span id="piTotal">0</span></h5></div>
            </div>
            <button class="btn btn-sp mt-3" onclick="saveProforma()">üíæ Save Proforma & Generate PI</button>
        </div>
        <div class="card-dash mt-4">
            <h6>üìã Recent PIs</h6>
            <table class="table">
                <thead><tr><th>PI #</th><th>Customer</th><th>Total</th><th>Action</th></tr></thead>
                <tbody>
                    ${appData.proformas.slice(-5).map(p => `<tr><td>PI-${p.id}</td><td>${getCustomerName(p.custId)}</td><td>‚Çπ${p.total}</td><td><button class="btn btn-sm btn-outline-success" onclick="convertToOrder(${p.id})">‚Üí Order</button></td></tr>`).join('')}
                </tbody>
            </table>
        </div>
        `;
    }

    // PI items (temporary session)
    let piItems = [];
    window.addProformaItem = function() {
        let w = parseFloat(document.getElementById('itemWidth').value) || 0;
        let h = parseFloat(document.getElementById('itemHeight').value) || 0;
        let glassId = parseInt(document.getElementById('itemGlass').value);
        let qty = parseFloat(document.getElementById('itemQty').value) || 1;
        let glass = appData.glassTypes.find(g=>g.id==glassId);
        if(!glass) return;
        let sqft = w * h;
        let rate = glass.rate;
        // check if special price for customer
        let custId = parseInt(document.getElementById('piCust')?.value);
        let special = appData.priceList.find(p => p.custId == custId && p.glassId == glassId);
        if(special) rate = special.customRate;
        let amount = sqft * rate * qty;
        piItems.push({ width:w, height:h, sqft, glassId, glassName: glass.name, rate, qty, amount });
        refreshPiTable();
    }
    function refreshPiTable() {
        let tbody = document.getElementById('piItemsBody');
        if (!tbody) return;
        let html = '';
        let subtotal = 0;
        piItems.forEach((it, idx) => {
            subtotal += it.amount;
            html += `<tr><td>${it.glassName}</td><td>${it.width}'√ó${it.height}'</td><td>${it.sqft.toFixed(2)}</td><td>‚Çπ${it.rate}</td><td>${it.qty}</td><td>‚Çπ${it.amount.toFixed(2)}</td></tr>`;
        });
        tbody.innerHTML = html;
        document.getElementById('piSubtotal').innerText = subtotal.toFixed(2);
        let gstRate = parseFloat(document.getElementById('piGstFlag')?.value || 18);
        let gstAmt = subtotal * gstRate/100;
        document.getElementById('piGstAmount').innerText = gstAmt.toFixed(2);
        document.getElementById('piTotal').innerText = (subtotal + gstAmt).toFixed(2);
    }

    window.saveProforma = function() {
        let custId = parseInt(document.getElementById('piCust').value);
        let subtotal = parseFloat(document.getElementById('piSubtotal').innerText);
        let gst = parseFloat(document.getElementById('piGstAmount').innerText);
        let total = parseFloat(document.getElementById('piTotal').innerText);
        if(piItems.length===0) { alert('Add items!'); return; }
        let newPI = {
            id: Date.now(),
            custId, date: new Date().toISOString().slice(0,10),
            items: [...piItems],
            subtotal, gst, total
        };
        appData.proformas.push(newPI);
        saveData();
        piItems = []; refreshPiTable();
        alert('Proforma saved! Can convert to order.');
        showPage('proforma');
    }

    // ------------------------------------------------------------
    //  4. WORK ORDER ‚Üí FLOOR DEPARTMENT
    // ------------------------------------------------------------
    window.convertToOrder = function(piId) {
        let pi = appData.proformas.find(p => p.id == piId);
        if(!pi) return;
        let dept = prompt('Assign department (Cutting / Edging / Tempering / Packing)', 'Cutting');
        let order = {
            id: Date.now(),
            piId: pi.id,
            custId: pi.custId,
            date: new Date().toISOString().slice(0,10),
            department: dept,
            items: pi.items,
            status: 'Pending'
        };
        appData.workOrders.push(order);
        saveData();
        alert(`Order #${order.id} generated for ${dept}`);
        showPage('orderFloor');
    }

    function renderOrderFloor() {
        return `
        <div class="page-title">‚öôÔ∏è Floor Work Orders (Department wise)</div>
        <div class="card-dash">
            <h6>üî® All Active Orders</h6>
            <table class="table">
                <thead><tr><th>Order No</th><th>PI Ref</th><th>Department</th><th>Status</th><th>Action</th></tr></thead>
                <tbody>
                    ${appData.workOrders.map(o => `<tr>
                        <td>WO-${o.id}</td><td>PI-${o.piId}</td><td><span class="department-badge">${o.department}</span></td>
                        <td><span class="badge ${o.status==='Pending'?'bg-warning': o.status==='In Progress'?'bg-primary':'bg-success'}">${o.status}</span></td>
                        <td><button class="btn btn-sm btn-outline-secondary" onclick="updateOrderStatus(${o.id})">Update</button>
                        <button class="btn btn-sm btn-outline-info" onclick="dispatchFromOrder(${o.id})">Despatch</button></td>
                    </tr>`).join('')}
                </tbody>
            </table>
        </div>
        `;
    }
    window.updateOrderStatus = function(orderId) {
        let order = appData.workOrders.find(o=>o.id==orderId);
        if(order) { order.status = 'In Progress'; saveData(); showPage('orderFloor'); }
    }
    window.dispatchFromOrder = function(orderId) {
        let order = appData.workOrders.find(o=>o.id==orderId);
        if(!order) return;
        appData.despatches.push({
            id: Date.now(),
            orderId: order.id,
            date: new Date().toISOString().slice(0,10),
            status: 'Dispatched',
            tracking: 'SP7' + Math.floor(Math.random()*1000)
        });
        order.status = 'Dispatched';
        saveData(); alert('Despatch entry created'); showPage('despatch');
    }

    // ------------------------------------------------------------
    //  5. DESPATCH TRACKER (LIVE)
    // ------------------------------------------------------------
    function renderDespatch() {
        return `
        <div class="page-title">üöõ Live Despatch Tracker</div>
        <div class="card-dash">
            <table class="table">
                <thead><tr><th>Despatch ID</th><th>Order Ref</th><th>Date</th><th>Tracking</th><th>Status</th></tr></thead>
                <tbody>
                    ${appData.despatches.map(d => `<tr><td>D-${d.id}</td><td>WO-${d.orderId}</td><td>${d.date}</td><td>${d.tracking}</td><td><span class="badge bg-success">Delivered (live)</span></td></tr>`).join('')}
                </tbody>
            </table>
        </div>
        `;
    }

    // ------------------------------------------------------------
    //  6. BILLING + GST INVOICE
    // ------------------------------------------------------------
    function renderBilling() {
        return `
        <div class="page-title">üí∞ GST Billing & Invoice</div>
        <div class="card-dash">
            <h6>Pending Despatches to Bill</h6>
            <table class="table">
                <tr><th>Despatch</th><th>Order</th><th>Action</th></tr>
                ${appData.despatches.map(d => `<tr><td>D-${d.id}</td><td>WO-${d.orderId}</td><td><button class="btn btn-sp btn-sm" onclick="generateInvoice(${d.id})">Create GST Invoice</button></td></tr>`).join('')}
            </table>
            <hr><h6>Recent Invoices</h6>
            <table class="table">${appData.invoices.map(i => `<tr><td>INV-${i.id}</td><td>‚Çπ${i.amount}</td><td>GST: ‚Çπ${i.gst}</td></tr>`).join('') || '<tr><td>No invoice yet</td></tr>'}</table>
        </div>
        `;
    }
    window.generateInvoice = function(despatchId) {
        let despatch = appData.despatches.find(d=>d.id==despatchId);
        let order = appData.workOrders.find(o=>o.id==despatch?.orderId);
        if(order) {
            let pi = appData.proformas.find(p=>p.id==order.piId);
            let inv = { id: Date.now(), despatchId, orderId: order.id, amount: pi?.total || 1000, gst: pi?.gst || 180, date: new Date().toISOString().slice(0,10) };
            appData.invoices.push(inv);
            saveData(); alert('Invoice generated!'); showPage('billing');
        }
    }

    // ------------------------------------------------------------
    //  7. REPORTS (A to Z)
    // ------------------------------------------------------------
    function renderReports() {
        return `<div class="page-title">üìà A‚ÄìZ Reports</div>
        <div class="row">
            <div class="col-md-6"><div class="card-dash"><h6>Stock Summary</h6>${appData.glassTypes.map(g => `<p>${g.name} : 1000 sqft (demo)</p>`).join('')}</div></div>
            <div class="col-md-6"><div class="card-dash"><h6>GST Summary</h6><p>Total GST Collected: ‚Çπ${appData.invoices.reduce((a,i)=>a+(i.gst||0),0)}</p></div></div>
            <div class="col-md-12 mt-3"><div class="card-dash"><h6>Party Outstanding</h6>${appData.customers.map(c=>`<p>${c.name} : ‚Çπ${Math.floor(Math.random()*5000)}</p>`).join('')}</div></div>
        </div>`;
    }

    // ------------------------------------------------------------
    //  8. LEDGER (Party hisab kitab)
    // ------------------------------------------------------------
    function renderLedger() {
        return `<div class="page-title">üìí Party Ledger (Hisab Kitab)</div>
        <div class="card-dash">
            <select class="form-select w-50 mb-3" id="ledgerCust"><option value="">Select Party</option>${appData.customers.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}</select>
            <button class="btn btn-sp" onclick="viewLedger()">View Ledger</button>
            <div id="ledgerEntries" class="mt-4"></div>
        </div>`;
    }
    window.viewLedger = function() {
        let custId = parseInt(document.getElementById('ledgerCust')?.value);
        if(!custId) return;
        let entries = `<h6>Ledger of ${getCustomerName(custId)}</h6><table class="table"><tr><th>Date</th><th>Transaction</th><th>Debit</th><th>Credit</th></tr>`;
        entries += `<tr><td>${new Date().toLocaleDateString()}</td><td>Opening Balance</td><td>‚Çπ0</td><td>‚Çπ0</td></tr>`;
        appData.invoices.filter(i=> { let o = appData.workOrders.find(o=>o.id==i.orderId); return o && o.custId == custId; }).forEach(inv => entries += `<tr><td>${inv.date}</td><td>Invoice INV-${inv.id}</td><td>‚Çπ${inv.amount}</td><td>-</td></tr>`);
        document.getElementById('ledgerEntries').innerHTML = entries + `</table>`;
    }

    // ------------------------------------------------------------
    //  9. AUTO BACKUP (export/import)
    // ------------------------------------------------------------
    function renderBackup() {
        return `<div class="page-title">üíæ Auto Backup & Restore</div>
        <div class="card-dash">
            <button class="btn btn-sp" onclick="exportBackup()"><i class="bi bi-download"></i> Download Backup (JSON)</button>
            <button class="btn btn-outline-secondary ms-3" onclick="importBackup()"><i class="bi bi-upload"></i> Restore Backup</button>
            <p class="mt-3 text-muted">Last auto-backup: on every change (localStorage)</p>
        </div>`;
    }
    window.exportBackup = function() {
        let dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData,null,2));
        let a = document.createElement('a'); a.href = dataStr; a.download = 'SP7_backup.json'; a.click();
    }
    window.importBackup = function() {
        alert('Paste SP7_backup.json into demo (use file reader) ‚Äì For now, demo reloads default.');
    }

    // ------------------------------------------------------------
    //  SIDEBAR TOGGLE (mobile)
    // ------------------------------------------------------------
    window.toggleSidebar = function() {
        document.getElementById('sidebar').classList.toggle('show');
    }

    // ------------------------------------------------------------
    //  INITIAL PAGE
    // ------------------------------------------------------------
    window.onload = function() {
        showPage('dashboard');
    }
</script>

<!-- Bootstrap JS (for toggles etc) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
