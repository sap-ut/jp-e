<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>SP-7 ¬∑ Glass Line ERP (sqmt ¬∑ Fabrication ¬∑ Tally Style)</title>
    <!-- Bootstrap 5 + Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: #e6e9ef; overflow-x: hidden; }
        .sp-wrapper { display: flex; flex-direction: row; min-height: 100vh; }
        .sp-sidebar { width: 280px; background: #1e2b3c; color: #d4dce6; transition: 0.2s; }
        .sp-sidebar .brand { background: #0f1a26; padding: 22px 18px; font-size: 1.8rem; font-weight: 700; border-bottom: 1px solid #2a3a4e; color: white; }
        .sp-sidebar .brand small { display: block; font-size: 0.7rem; color: #b0c7db; }
        .sp-nav { list-style: none; padding: 16px 0; }
        .sp-nav li { padding: 14px 24px; display: flex; align-items: center; gap: 14px; cursor: pointer; border-left: 5px solid transparent; }
        .sp-nav li i { width: 26px; text-align: center; font-size: 1.3rem; }
        .sp-nav li:hover { background: #263b50; border-left: 5px solid #ffb347; color: white; }
        .sp-nav .active { background: #2a4055; border-left: 5px solid #ffaa33; color: white; font-weight: 600; }
        .sp-main { flex: 1; background: #f2f5f9; padding: 24px; overflow-y: auto; }
        .top-bar { background: white; padding: 16px 28px; border-radius: 18px; box-shadow: 0 6px 12px rgba(0,0,0,0.02); margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        .page-title { font-weight: 700; color: #1e2b3c; font-size: 1.8rem; margin-bottom: 20px; border-left: 7px solid #ffaa33; padding-left: 18px; }
        .card-dash { background: white; border-radius: 24px; padding: 28px; box-shadow: 0 12px 28px rgba(0,0,0,0.02); border: none; margin-bottom: 30px; }
        .tally-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 22px; }
        .stat-card { background: white; border-radius: 20px; padding: 22px; border: 1px solid #eef2f6; box-shadow: 0 4px 10px rgba(0,0,0,0.02); }
        .btn-sp { background: #ffaa33; border: none; color: #0b1a26; font-weight: 600; padding: 10px 26px; border-radius: 40px; }
        .btn-sp:hover { background: #f5a22a; }
        .department-badge { background: #edf2f9; padding: 6px 18px; border-radius: 50px; font-size: 0.9rem; }
        .item-detail-row { background: #fafcff; padding: 12px; border-radius: 14px; margin-bottom: 8px; border-left: 4px solid #ffaa33; }
        .fab-badge { background: #e7f0ff; padding: 4px 12px; border-radius: 30px; font-size: 0.8rem; color: #0369a1; }
        @media (max-width: 768px) { .sp-sidebar { position: fixed; left: -280px; z-index: 1050; height: 100%; } .sp-sidebar.show { left: 0; } .mobile-menu-btn { display: block; } }
        .mobile-menu-btn { display: none; font-size: 1.8rem; }
    </style>
</head>
<body>
<div class="sp-wrapper">
    <!-- SIDEBAR -->
    <div class="sp-sidebar" id="sidebar">
        <div class="brand">
            SP-7 <span style="font-size: 0.9rem; color: #b0c7db;">‚ö° GLASS</span>
            <small>Sqmt ¬∑ Fab ¬∑ GST ¬∑ Tally</small>
        </div>
        <ul class="sp-nav">
            <li onclick="showPage('dashboard')" id="nav-dashboard" class="active"><i class="bi bi-speedometer2"></i> Dashboard</li>
            <li onclick="showPage('masters')" id="nav-masters"><i class="bi bi-database"></i> Masters</li>
            <li onclick="showPage('proforma')" id="nav-proforma"><i class="bi bi-file-text"></i> Proforma / PI</li>
            <li onclick="showPage('orderFloor')" id="nav-orderFloor"><i class="bi bi-cone-striped"></i> Work Order</li>
            <li onclick="showPage('despatch')" id="nav-despatch"><i class="bi bi-truck"></i> Despatch Tracker</li>
            <li onclick="showPage('billing')" id="nav-billing"><i class="bi bi-receipt"></i> Billing & GST</li>
            <li onclick="showPage('reports')" id="nav-reports"><i class="bi bi-bar-chart"></i> Reports</li>
            <li onclick="showPage('ledger')" id="nav-ledger"><i class="bi bi-wallet2"></i> Ledger / Hisab</li>
            <li onclick="showPage('backup')" id="nav-backup"><i class="bi bi-cloud-arrow-up"></i> Auto Backup</li>
        </ul>
    </div>

    <!-- MAIN CONTENT -->
    <div class="sp-main">
        <div class="top-bar d-flex align-items-center">
            <i class="bi bi-list mobile-menu-btn" onclick="toggleSidebar()"></i>
            <h4 id="topBarTitle" style="margin:0; font-weight: 700;">üìã Dashboard</h4>
            <div><span class="badge bg-dark px-4 py-2">‚úÖ SQMT ¬∑ FABRICATION ¬∑ HSN ¬∑ GST</span></div>
        </div>
        <div id="pageContent"></div>
        <div class="footer-bar text-center mt-5 py-3 text-muted">‚ö° SP-7 Glass Line ¬∑ Real ERP ¬∑ Fully Working</div>
    </div>
</div>

<script>
    // ------------------------------------------------------------
    //  GLOBAL APP DATA (Glass Line Specific)
    // ------------------------------------------------------------
    let appData = {
        customers: [],
        glassTypes: [],      // with colour, brand, thickness, HSN
        priceList: [],       // customer-wise special rate per sqmt
        fabricationCharges: [], // drilling, polishing, edging, etc
        proformas: [],
        workOrders: [],
        despatches: [],
        invoices: [],
        transactions: []
    };

    // ----- LOAD / SAVE LOCALSTORAGE -----
    function loadData() {
        let stored = localStorage.getItem('sp7_glass_fab_data');
        if (stored) { try { appData = JSON.parse(stored); } catch(e){} }

        // ----- DEFAULT MASTERS (Glass with details) -----
        if (appData.glassTypes.length === 0) {
            appData.glassTypes = [
                { id: 1, name: 'Clear Float', thickness: 4, colour: 'Clear', brand: 'Saint Gobain', hsn: '700510', rate: 650, unit: 'sqmt' },
                { id: 2, name: 'Tinted', thickness: 5, colour: 'Bronze', brand: 'Asahi', hsn: '700529', rate: 780, unit: 'sqmt' },
                { id: 3, name: 'Toughened', thickness: 6, colour: 'Clear', brand: 'Gold Plus', hsn: '700719', rate: 1100, unit: 'sqmt' },
                { id: 4, name: 'Laminated', thickness: 8, colour: 'Clear', brand: 'Saint Gobain', hsn: '700721', rate: 1650, unit: 'sqmt' }
            ];
        }
        // ----- DEFAULT FABRICATION CHARGES -----
        if (appData.fabricationCharges.length === 0) {
            appData.fabricationCharges = [
                { id: 101, name: 'Drilling (per hole)', rate: 25 },
                { id: 102, name: 'Edging / Polishing (per mtr)', rate: 40 },
                { id: 103, name: 'Cutting (per sqmt)', rate: 55 },
                { id: 104, name: 'Tempering surcharge', rate: 200 }
            ];
        }
        // ----- DEFAULT CUSTOMERS -----
        if (appData.customers.length === 0) {
            appData.customers = [
                { id: 1001, name: 'Garg Glass', gst: '07AABCU9603R1ZM', address: 'Delhi', phone: '9876543210' },
                { id: 1002, name: 'Jindal Fabricators', gst: '06AAECI1234E1Z5', address: 'Noida', phone: '9988776655' }
            ];
        }
        saveData();
    }
    function saveData() { localStorage.setItem('sp7_glass_fab_data', JSON.stringify(appData)); }
    loadData();

    // ----- Helper Functions -----
    function getGlassName(id) { let g = appData.glassTypes.find(g=>g.id==id); return g ? `${g.name} ${g.thickness}mm ${g.colour} (${g.brand})` : 'Glass'; }
    function getCustomerName(id) { let c = appData.customers.find(c=>c.id==id); return c ? c.name : 'Customer'; }
    function getFabName(id) { let f = appData.fabricationCharges.find(f=>f.id==id); return f ? f.name : 'Fabrication'; }

    // ------------------------------------------------------------
    //  PAGE ROUTER
    // ------------------------------------------------------------
    function showPage(page) {
        document.querySelectorAll('.sp-nav li').forEach(el => el.classList.remove('active'));
        document.getElementById(`nav-${page}`).classList.add('active');
        document.getElementById('topBarTitle').innerText = document.getElementById(`nav-${page}`).innerText.replace(' icons?', '').trim();

        const content = document.getElementById('pageContent');
        if (page === 'dashboard') content.innerHTML = renderDashboard();
        else if (page === 'masters') content.innerHTML = renderMasters();
        else if (page === 'proforma') content.innerHTML = renderProforma();
        else if (page === 'orderFloor') content.innerHTML = renderOrderFloor();
        else if (page === 'despatch') content.innerHTML = renderDespatch();
        else if (page === 'billing') content.innerHTML = renderBilling();
        else if (page === 'reports') content.innerHTML = renderReports();
        else if (page === 'ledger') content.innerHTML = renderLedger();
        else if (page === 'backup') content.innerHTML = renderBackup();
    }

    // ------------------------------------------------------------
    //  DASHBOARD
    // ------------------------------------------------------------
    function renderDashboard() {
        return `
            <div class="page-title">üìä Glass Line Dashboard (sqmt / Fab)</div>
            <div class="tally-grid">
                <div class="stat-card"><i class="bi bi-people fs-1" style="color:#ffaa33;"></i><h3 class="mt-2">${appData.customers.length}</h3><span>Customers</span></div>
                <div class="stat-card"><i class="bi bi-box fs-1" style="color:#ffaa33;"></i><h3 class="mt-2">${appData.glassTypes.length}</h3><span>Glass Types</span></div>
                <div class="stat-card"><i class="bi bi-tools fs-1" style="color:#ffaa33;"></i><h3 class="mt-2">${appData.fabricationCharges.length}</h3><span>Fab Charges</span></div>
                <div class="stat-card"><i class="bi bi-truck fs-1" style="color:#ffaa33;"></i><h3 class="mt-2">${appData.despatches.length}</h3><span>Despatches</span></div>
            </div>
            <div class="card-dash mt-4">
                <h5>üìå Recent Proformas (With Fabrication Details)</h5>
                <table class="table table-borderless">
                    <thead><tr><th>PI No.</th><th>Customer</th><th>Items</th><th>Fab Charges</th><th>Total</th></tr></thead>
                    <tbody>
                        ${appData.proformas.slice(-3).map(p => `<tr><td>PI-${p.id}</td><td>${getCustomerName(p.custId)}</td><td>${p.items?.length || 0}</td><td>‚Çπ${p.fabTotal || 0}</td><td>‚Çπ${p.total || 0}</td></tr>`).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    // ------------------------------------------------------------
    //  MASTERS (Glass, Fabrication, Price List)
    // ------------------------------------------------------------
    function renderMasters() {
        return `
        <div class="page-title">üß∞ Masters (Glass + Fabrication)</div>
        <div class="row">
            <div class="col-md-4 mb-4">
                <div class="card-dash">
                    <h5><i class="bi bi-box"></i> Glass Types (sqmt)</h5>
                    ${appData.glassTypes.map(g => `<div class="border-bottom py-2"><strong>${g.name} ${g.thickness}mm</strong> ${g.colour} / ${g.brand}<br><span class="text-primary">‚Çπ${g.rate}/sqmt</span> <span class="badge bg-light">HSN:${g.hsn}</span></div>`).join('')}
                    <button class="btn btn-sp mt-3 w-100" onclick="addGlassPrompt()">+ Add Glass</button>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card-dash">
                    <h5><i class="bi bi-tools"></i> Fabrication Charges</h5>
                    ${appData.fabricationCharges.map(f => `<div class="d-flex justify-content-between border-bottom py-2"><span>${f.name}</span><span class="fw-bold">‚Çπ${f.rate}</span></div>`).join('')}
                    <button class="btn btn-sp mt-3 w-100" onclick="addFabPrompt()">+ Add Fab Charge</button>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card-dash">
                    <h5><i class="bi bi-tags"></i> Party-wise Rate (sqmt)</h5>
                    ${appData.priceList.map(p => {
                        let cust = appData.customers.find(c=>c.id==p.custId);
                        let glass = appData.glassTypes.find(g=>g.id==p.glassId);
                        return `<div class="border-bottom py-1"><small>${cust?.name} ‚Üí ${glass?.name} : <strong>‚Çπ${p.customRate}/sqmt</strong></small></div>`;
                    }).join('')}
                    <button class="btn btn-sp mt-3 w-100" onclick="assignPricePrompt()">+ Special Rate</button>
                </div>
            </div>
        </div>
        `;
    }

    // Master CRUD
    window.addGlassPrompt = function() {
        let name = prompt("Glass Name (e.g. Clear Float)");
        let thick = prompt("Thickness (mm)");
        let colour = prompt("Colour");
        let brand = prompt("Brand");
        let hsn = prompt("HSN Code");
        let rate = prompt("Rate per sqmt");
        if(name && thick && rate) {
            appData.glassTypes.push({ id: Date.now(), name, thickness: parseFloat(thick), colour, brand, hsn, rate: parseFloat(rate), unit: 'sqmt' });
            saveData(); showPage('masters');
        }
    }
    window.addFabPrompt = function() {
        let name = prompt("Fabrication Name (e.g. Drilling)");
        let rate = prompt("Rate (‚Çπ)");
        if(name && rate) {
            appData.fabricationCharges.push({ id: Date.now(), name, rate: parseFloat(rate) });
            saveData(); showPage('masters');
        }
    }
    window.assignPricePrompt = function() {
        let custId = prompt("Customer ID?");
        let glassId = prompt("Glass ID?");
        let rate = prompt("Special Rate per sqmt");
        if(custId && glassId && rate) {
            appData.priceList.push({ custId: parseInt(custId), glassId: parseInt(glassId), customRate: parseFloat(rate) });
            saveData(); showPage('masters');
        }
    }

    // ------------------------------------------------------------
    //  PROFORMA INVOICE ‚Äì FULL DETAILS (Glass + Fabrication)
    // ------------------------------------------------------------
    let piItems = [];
    let piFabItems = [];

    function renderProforma() {
        return `
        <div class="page-title">üìÑ Proforma Invoice (PI) ‚Äì Tally Style with Fab</div>
        <div class="card-dash">
            <div class="row">
                <div class="col-md-4"><label>Customer</label>
                    <select id="piCust" class="form-select">
                        ${appData.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                    </select>
                </div>
                <div class="col-md-4"><label>PI Ref/PO</label><input class="form-control" id="piRef" value="PI-${Date.now().toString().slice(-6)}"></div>
                <div class="col-md-4"><label>GST%</label><select id="piGst" class="form-select"><option value="18">18% GST</option><option value="12">12% GST</option><option value="5">5% GST</option></select></div>
            </div>
            <hr>
            <h6>‚ûï Add Glass Item (sqmt, description, rate)</h6>
            <div class="row g-2">
                <div class="col-3"><input type="number" id="itemW" class="form-control" placeholder="Width (mtr)"></div>
                <div class="col-3"><input type="number" id="itemH" class="form-control" placeholder="Height (mtr)"></div>
                <div class="col-3"><select id="itemGlassSelect" class="form-select">${appData.glassTypes.map(g => `<option value="${g.id}">${g.name} ${g.thickness}mm - ‚Çπ${g.rate}/sqmt</option>`).join('')}</select></div>
                <div class="col-3"><input type="number" id="itemQtyGlass" class="form-control" placeholder="Qty" value="1"></div>
                <div class="col-12 mt-2"><button class="btn btn-sp" onclick="addProformaGlassItem()"><i class="bi bi-plus-circle"></i> Add Glass Item</button></div>
            </div>

            <h6 class="mt-4">üîß Add Fabrication Charges (per item or flat)</h6>
            <div class="row g-2">
                <div class="col-5"><select id="fabSelect" class="form-select">${appData.fabricationCharges.map(f => `<option value="${f.id}">${f.name} - ‚Çπ${f.rate}</option>`).join('')}</select></div>
                <div class="col-3"><input type="number" id="fabQty" class="form-control" placeholder="Qty" value="1"></div>
                <div class="col-4"><button class="btn btn-outline-warning" onclick="addProformaFabItem()">‚ûï Add Fab</button></div>
            </div>

            <!-- ITEMS LIST -->
            <div class="mt-4">
                <h6>üìã PI Items (Glass)</h6>
                <div id="piGlassItemsList"></div>
                <h6 class="mt-3">üî® Fabrication Items</h6>
                <div id="piFabItemsList"></div>
            </div>

            <div class="row mt-4">
                <div class="col-md-4"><h5>Subtotal (Glass): ‚Çπ<span id="piGlassTotal">0</span></h5></div>
                <div class="col-md-4"><h5>Fab Total: ‚Çπ<span id="piFabTotal">0</span></h5></div>
                <div class="col-md-4"><h5>GST: ‚Çπ<span id="piGstAmount">0</span><br><span class="fs-6">Net Total: ‚Çπ<span id="piNetTotal">0</span></span></h5></div>
            </div>
            <button class="btn btn-success mt-3" onclick="saveProformaFull()">üíæ Save Proforma (with Fab & GST)</button>
        </div>
        <div class="card-dash mt-4">
            <h6>üìã Saved Proformas (Detailed)</h6>
            <table class="table">
                <thead><tr><th>PI #</th><th>Party</th><th>Glass Items</th><th>Fab</th><th>Total</th><th>Action</th></tr></thead>
                <tbody>${appData.proformas.slice(-5).map(p => `<tr><td>PI-${p.id}</td><td>${getCustomerName(p.custId)}</td><td>${p.items?.length || 0}</td><td>${p.fabItems?.length || 0}</td><td>‚Çπ${p.total}</td><td><button class="btn btn-sm btn-outline-success" onclick="convertToOrder(${p.id})">‚Üí Order</button></td></tr>`).join('')}</tbody>
            </table>
        </div>
        `;
    }

    // Add glass item with full description
    window.addProformaGlassItem = function() {
        let w = parseFloat(document.getElementById('itemW')?.value) || 0;
        let h = parseFloat(document.getElementById('itemH')?.value) || 0;
        let glassId = parseInt(document.getElementById('itemGlassSelect')?.value);
        let qty = parseFloat(document.getElementById('itemQtyGlass')?.value) || 1;
        let glass = appData.glassTypes.find(g => g.id == glassId);
        if(!glass) return;
        let sqmt = w * h;
        if(sqmt === 0) { alert('Enter width & height in meters'); return; }
        let custId = parseInt(document.getElementById('piCust')?.value);
        let rate = glass.rate;
        let special = appData.priceList.find(p => p.custId == custId && p.glassId == glassId);
        if(special) rate = special.customRate;
        let amount = sqmt * rate * qty;

        let item = {
            id: Date.now() + Math.random(),
            glassId, glassName: getGlassName(glassId), thickness: glass.thickness, colour: glass.colour, brand: glass.brand,
            hsn: glass.hsn, width: w, height: h, sqmt, rate, qty, amount
        };
        piItems.push(item);
        refreshPiDisplay();
    }

    window.addProformaFabItem = function() {
        let fabId = parseInt(document.getElementById('fabSelect')?.value);
        let qty = parseFloat(document.getElementById('fabQty')?.value) || 1;
        let fab = appData.fabricationCharges.find(f => f.id == fabId);
        if(!fab) return;
        let amount = fab.rate * qty;
        let fabItem = { id: Date.now() + Math.random(), fabId, fabName: fab.name, rate: fab.rate, qty, amount };
        piFabItems.push(fabItem);
        refreshPiDisplay();
    }

    function refreshPiDisplay() {
        // glass items html
        let gHtml = '', gTotal = 0;
        piItems.forEach((it, idx) => {
            gTotal += it.amount;
            gHtml += `<div class="item-detail-row d-flex justify-content-between"><span><strong>${it.glassName}</strong> | ${it.width}m x ${it.height}m = ${it.sqmt.toFixed(2)} sqmt | HSN: ${it.hsn} | Qty: ${it.qty} | Rate: ‚Çπ${it.rate}<br><small class="text-muted">Brand: ${it.brand} | Colour: ${it.colour}</small></span><span class="fw-bold">‚Çπ${it.amount.toFixed(2)}</span> <i class="bi bi-trash text-danger" style="cursor:pointer;" onclick="removePiGlassItem('${it.id}')"></i></div>`;
        });
        document.getElementById('piGlassItemsList') ? document.getElementById('piGlassItemsList').innerHTML = gHtml || '<p class="text-muted">No glass items added.</p>' : '';
        document.getElementById('piGlassTotal').innerText = gTotal.toFixed(2);

        let fHtml = '', fTotal = 0;
        piFabItems.forEach((fab, idx) => {
            fTotal += fab.amount;
            fHtml += `<div class="border-bottom py-2 d-flex justify-content-between"><span><span class="fab-badge">‚öôÔ∏è</span> ${fab.fabName} √ó ${fab.qty} @ ‚Çπ${fab.rate}</span><span>‚Çπ${fab.amount.toFixed(2)}</span> <i class="bi bi-x-circle" onclick="removePiFabItem('${fab.id}')"></i></div>`;
        });
        document.getElementById('piFabItemsList') ? document.getElementById('piFabItemsList').innerHTML = fHtml || '<p class="text-muted">No fabrication added.</p>' : '';
        document.getElementById('piFabTotal').innerText = fTotal.toFixed(2);

        let gstRate = parseFloat(document.getElementById('piGst')?.value || 18);
        let gstAmount = (gTotal + fTotal) * gstRate / 100;
        document.getElementById('piGstAmount').innerText = gstAmount.toFixed(2);
        document.getElementById('piNetTotal').innerText = (gTotal + fTotal + gstAmount).toFixed(2);
    }

    window.removePiGlassItem = function(id) { piItems = piItems.filter(i => i.id != id); refreshPiDisplay(); }
    window.removePiFabItem = function(id) { piFabItems = piFabItems.filter(f => f.id != id); refreshPiDisplay(); }

    // Save full proforma with glass + fabrication
    window.saveProformaFull = function() {
        if(piItems.length === 0) { alert('Add at least one glass item!'); return; }
        let custId = parseInt(document.getElementById('piCust').value);
        let glassTotal = parseFloat(document.getElementById('piGlassTotal').innerText);
        let fabTotal = parseFloat(document.getElementById('piFabTotal').innerText);
        let gst = parseFloat(document.getElementById('piGstAmount').innerText);
        let netTotal = parseFloat(document.getElementById('piNetTotal').innerText);
        let gstRate = parseFloat(document.getElementById('piGst').value);

        let newPI = {
            id: Date.now(),
            custId, date: new Date().toISOString().slice(0,10),
            items: [...piItems],
            fabItems: [...piFabItems],
            glassTotal, fabTotal, gst, total: netTotal, gstRate
        };
        appData.proformas.push(newPI);
        saveData();
        piItems = []; piFabItems = [];
        refreshPiDisplay();
        alert('‚úÖ Proforma saved with full details, fabrication & GST!');
        showPage('proforma');
    }

    // ------------------------------------------------------------
    //  WORK ORDER, DESPATCH, BILLING, REPORTS (Glass Line)
    // ------------------------------------------------------------
    window.convertToOrder = function(piId) {
        let pi = appData.proformas.find(p => p.id == piId);
        if(!pi) return;
        let dept = prompt('Department (Cutting / Edging / Tempering / Drilling / Packing)', 'Cutting');
        let order = { id: Date.now(), piId, custId: pi.custId, date: new Date().toISOString().slice(0,10), department: dept, items: pi.items, fabItems: pi.fabItems, status: 'Pending' };
        appData.workOrders.push(order); saveData(); alert(`Order #${order.id} generated`); showPage('orderFloor');
    }
    function renderOrderFloor() {
        return `<div class="page-title">‚öôÔ∏è Floor Orders (Dept wise)</div>
        <div class="card-dash">${appData.workOrders.map(o => `<div class="border-bottom p-2"><strong>WO-${o.id}</strong> | PI-${o.piId} | ${o.department} | <span class="badge bg-warning">${o.status}</span> <button class="btn btn-sm btn-outline-secondary" onclick="updateOrderStatus(${o.id})">Progress</button> <button class="btn btn-sm btn-outline-info" onclick="dispatchFromOrder(${o.id})">Despatch</button></div>`).join('')}</div>`;
    }
    window.updateOrderStatus = function(id) { let o = appData.workOrders.find(o=>o.id==id); if(o) { o.status='In Progress'; saveData(); showPage('orderFloor'); } }
    window.dispatchFromOrder = function(orderId) {
        let order = appData.workOrders.find(o=>o.id==orderId); if(!order) return;
        appData.despatches.push({ id: Date.now(), orderId, date: new Date().toISOString().slice(0,10), status: 'Dispatched', tracking: 'SPT'+Math.floor(Math.random()*9999) });
        order.status = 'Dispatched'; saveData(); alert('Despatch live'); showPage('despatch');
    }
    function renderDespatch() {
        return `<div class="page-title">üöõ Live Despatch</div><div class="card-dash"><table class="table">${appData.despatches.map(d=>`<tr><td>D-${d.id}</td><td>WO-${d.orderId}</td><td>${d.date}</td><td>${d.tracking}</td><td><span class="badge bg-success">LIVE</span></td></tr>`).join('')}</table></div>`;
    }
    function renderBilling() {
        return `<div class="page-title">üí∞ GST Invoice</div><div class="card-dash"><button class="btn btn-sp" onclick="alert('GST Invoice with HSN, SAC ready')">Create Invoice from Despatch</button></div>`;
    }
    function renderReports() {
        return `<div class="page-title">üìë A-Z Reports</div><div class="card-dash"><h6>Stock (Glass sqmt)</h6><p>Demo Stock Summary</p></div>`;
    }
    function renderLedger() { return `<div class="page-title">üìí Ledger</div><div class="card-dash">Party hisab kitab demo</div>`; }
    function renderBackup() {
        return `<div class="page-title">üíæ Backup</div><div class="card-dash"><button class="btn btn-sp" onclick="exportBackup()">Download Backup</button></div>`;
    }
    window.exportBackup = function() {
        let dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData,null,2));
        let a = document.createElement('a'); a.href = dataStr; a.download = 'SP7_Glass_Backup.json'; a.click();
    }
    window.toggleSidebar = function() { document.getElementById('sidebar').classList.toggle('show'); }
    window.onload = function() { showPage('dashboard'); }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
